/*! 5e-battletracker 2016-03-25 */
function guid(){function s4(){return Math.floor(65536*(1+Math.random())).toString(16).substring(1)}return s4()+s4()+"-"+s4()+"-"+s4()+"-"+s4()+"-"+s4()+s4()+s4()}var app=angular.module("5e-battletracker",[]);app.controller("BattleCtrl",["$scope","$log",function($scope,$log){$scope.round=0,$scope.creatures=[],$scope.sortCreatures=function(){$scope.creatures.sort(function(a,b){return b.initiative-a.initiative})},$scope.restart=function(){$scope.round=0,$scope.creatures.length>0&&$scope.setCreatureActive(0);for(var i=1;i<$scope.creatures.length;i++)$scope.setCreatureInactive(i)},$scope.forward=function(){for(var active=-1,i=0;i<$scope.creatures.length;i++)if("active"==$scope.creatures[i].active){active=i,init=$scope.creatures[i].initiative;break}if(active+1==$scope.creatures.length){for($scope.round++,$scope.creatures.length>0&&$scope.setCreatureActive(0),i=1;i<$scope.creatures.length;i++)$scope.setCreatureInactive(i);for(i=0;i<$scope.creatures.length;i++)for(j=0;j<$scope.creatures[i].notes.length;j++)$scope.creatures[i].notes[j].rounds>0&&$scope.creatures[i].notes[j].rounds--}else for($scope.setCreatureInactive(active),$scope.setCreatureActive(active+1),j=0;j<$scope.creatures[active].notes.length;j++)$scope.creatures[active].notes[j].turns>0&&$scope.creatures[active].notes[j].turns--},$scope.add=function(){var newCreature={id:guid(),name:"New creature",active:"inactive",description:"",initiative:0,hp:null,reaction:!0,notes:[]};0==$scope.creatures.length&&(newCreature.active="active"),$scope.creatures.push(newCreature)},$scope["delete"]=function(id){for(var i=0;i<$scope.creatures.length;i++)if(creature=$scope.creatures[i],"active"==creature.active&&$scope.forward(),creature.id==id){$scope.creatures.splice(i,1);break}},$scope.clone=function(id){for(var i=0;i<$scope.creatures.length;i++)if(creature=$scope.creatures[i],creature.id==id){var newCreature={id:guid(),name:creature.name,active:"inactive",description:creature.description,initiative:creature.initiative,hp:creature.hp,reaction:creature.reaction,notes:[]};newCreature.name=newCreature.name.replace(/\d+$/,function(match){var number=parseInt(match);return number++,number}),$scope.creatures.push(newCreature);break}},$scope.addNote=function(creatureID){for(var i=0;i<$scope.creatures.length;i++)if(creature=$scope.creatures[i],creature.id==creatureID){var newNote={id:guid(),text:"New note",rounds:null,turns:null};creature.notes.push(newNote);break}},$scope.deleteNote=function(creatureID,noteID){search:for(var i=0;i<$scope.creatures.length;i++)if(creature=$scope.creatures[i],creature.id==creatureID)for(j=0;j<creature.notes.length;j++)if(note=creature.notes[j],note.id==noteID){creature.notes.splice(j,1);break search}},$scope.setCreatureActive=function(index){$scope.creatures[index].active="active",$scope.creatures[index].reaction=!0},$scope.setCreatureInactive=function(index){$scope.creatures[index].active="inactive"}}]),app.directive("btCreature",function(){return{templateUrl:"views/creature.html"}});